<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Electrical Quiz App</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            box-sizing: border-box;
        }
        .quiz-container {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            max-width: 100%; /* Ensures it expands to full available width */
            width: 100%; /* Ensures it expands */
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            text-align: center; /* Center content within container */
        }

        /* Adjust quiz-container padding for smaller screens if needed to prevent squishing */
        @media (max-width: 768px) {
            .quiz-container {
                padding: 1rem; /* Slightly less padding on smaller screens */
            }
        }

        .score-display {
            display: flex;
            justify-content: space-around;
            align-items: center;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: #374151;
        }
        .score-correct {
            color: #10b981; /* Green */
        }
        .score-incorrect {
            color: #ef4444; /* Red */
        }

        .question-text {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1.5rem;
        }
        .option-button {
            width: 100%;
            padding: 1rem 1.5rem;
            margin-bottom: 0.75rem;
            border-radius: 0.75rem;
            background-color: #e0e7ff; /* Light blue */
            color: #4338ca; /* Darker blue */
            font-size: 1.1rem;
            font-weight: 500;
            text-align: left;
            border: 2px solid transparent;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .option-button:hover:not(.selected):not(.correct):not(.incorrect):not(:disabled) {
            background-color: #c7d2fe; /* Lighter hover blue */
        }
        .option-button.selected {
            background-color: #93c5fd; /* Medium blue for selected */
            border-color: #3b82f6; /* Accent border */
            color: #1e3a8a;
        }
        .option-button.correct {
            background-color: #d1fae5; /* Light green */
            border-color: #34d399; /* Green border */
            color: #065f46;
        }
        .option-button.incorrect {
            background-color: #fee2e2; /* Light red */
            border-color: #ef4444; /* Red border */
            color: #991b1b;
        }
        .option-button:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        .action-button {
            width: 100%;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            background-color: #4f46e5; /* Indigo */
            color: #ffffff;
            font-size: 1.2rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            box-shadow: 0 4px 8px rgba(79, 70, 229, 0.2);
            margin-top: 0.5rem; /* Adjust margin for multiple buttons */
        }
        .action-button:hover:not(:disabled) {
            background-color: #4338ca; /* Darker indigo on hover */
        }
        .action-button:disabled {
            background-color: #a5b4fc; /* Lighter indigo when disabled */
            cursor: not-allowed;
        }
        .feedback-container, .chat-container {
            margin-top: 1.5rem;
            padding: 1.25rem;
            border-radius: 0.75rem;
            background-color: #f0f9ff; /* Very light blue */
            border: 1px solid #bfdbfe; /* Light blue border */
            color: #1e40af; /* Dark blue text */
            font-size: 1rem;
            line-height: 1.6;
            text-align: left; /* Align text within feedback */
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 1rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #question-loading, #explanation-loading, #chat-loading {
            text-align: center;
            font-size: 1.1rem;
            color: #4b5563;
        }

        /* Chat specific styles */
        .chat-container {
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            gap: 1rem;
        }
        #chat-history {
            flex-grow: 1;
            overflow-y: auto;
            max-height: 300px;
            padding-right: 10px; /* For scrollbar */
            border-bottom: 1px solid #bfdbfe;
            margin-bottom: 1rem;
        }
        .chat-message {
            margin-bottom: 0.75rem;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            max-width: 80%;
        }
        .chat-message.user {
            background-color: #dbeafe; /* Light blue */
            color: #1e40af;
            align-self: flex-end;
            margin-left: auto;
        }
        .chat-message.ai {
            background-color: #f0fdf4; /* Light green */
            color: #065f46;
            align-self: flex-start;
            margin-right: auto;
        }
        #chat-input-area {
            display: flex;
            gap: 0.5rem;
        }
        #user-chat-input {
            flex-grow: 1;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #bfdbfe;
            resize: vertical;
            min-height: 40px;
        }
        #send-chat-button {
            padding: 0.75rem 1.25rem;
            background-color: #4f46e5;
            color: #ffffff;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
            border: none;
        }
        #send-chat-button:hover:not(:disabled) {
            background-color: #4338ca;
        }
        #send-chat-button:disabled {
            background-color: #a5b4fc;
            cursor: not-allowed;
        }
        #back-to-quiz-button {
            background-color: #6b7280; /* Gray */
            margin-top: 1rem;
        }
        #back-to-quiz-button:hover {
            background-color: #4b5563;
        }
    </style>
</head>
<body>
    <div class="quiz-container">
        <!-- Score Display -->
        <div id="score-display" class="score-display">
            <span id="correct-count" class="score-correct">Correct: 0</span>
            <span id="incorrect-count" class="score-incorrect">Incorrect: 0</span>
        </div>

        <!-- Question Area -->
        <div id="question-loading" class="hidden">
            <div class="loading-spinner"></div>
            <p>Generating new question...</p>
        </div>
        <div id="quiz-view">
            <div id="question-area">
                <p id="question-text" class="question-text"></p>
                <div id="options-container" class="space-y-3">
                    <!-- Options will be dynamically loaded here -->
                </div>
                <button id="submit-button" class="action-button mt-6">Submit Answer</button>
                <button id="next-button" class="action-button mt-6 hidden">Next Question</button>
            </div>

            <div id="feedback-area" class="feedback-container hidden">
                <div id="explanation-loading" class="hidden">
                    <div class="loading-spinner"></div>
                    <p class="text-center text-gray-600">Generating explanation...</p>
                </div>
                <p id="feedback-message" class="font-semibold text-lg text-center"></p>
                <p id="explanation-text" class="mt-2"></p>
                <button id="ask-for-more-details-button" class="action-button mt-4 hidden">Ask AI for More Details</button>
            </div>
        </div>

        <!-- Chat Area -->
        <div id="chat-view" class="chat-container hidden">
            <h2 class="text-2xl font-semibold text-center text-gray-700">AI Chat</h2>
            <div id="chat-history" class="flex flex-col">
                <!-- Chat messages will appear here -->
            </div>
            <div id="chat-loading" class="hidden">
                <div class="loading-spinner"></div>
                <p class="text-center text-gray-600">AI is typing...</p>
            </div>
            <div id="chat-input-area">
                <textarea id="user-chat-input" placeholder="Ask a follow-up question..." class="flex-grow"></textarea>
                <button id="send-chat-button" class="action-button">Send</button>
            </div>
            <button id="back-to-quiz-button" class="action-button">Back to Quiz</button>
        </div>
    </div>

    <script type="module">
        // Firebase imports (required for Canvas environment, though not directly used for storage here)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        // FIX: Corrected the reference to __initial_auth_token
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = 'anonymous'; // Default userId

        // Initialize Firebase and authenticate
        async function initializeFirebase() {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        userId = auth.currentUser?.uid || userId;
                        console.log("Firebase authenticated with custom token:", userId);
                    } else {
                        await signInAnonymously(auth);
                        userId = auth.currentUser?.uid || userId;
                        console.log("Firebase authenticated anonymously:", userId);
                    }
                } else {
                    console.warn("Firebase config not found. Running without Firebase.");
                }
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                // Fallback to running without Firebase if initialization fails
            }
        }

        // Call Firebase initialization
        initializeFirebase();

        let currentQuestion = null;
        let nextQuestionPreloaded = null; // Stores the next question generated in the background
        let selectedOption = null;
        let quizActive = true; // State to control quiz flow (e.g., prevent multiple submissions)
        let chatHistory = []; // Stores the conversation for the chat interface

        // Score tracking variables
        let correctCount = 0;
        let incorrectCount = 0;

        // DOM Elements - Quiz View
        const quizView = document.getElementById('quiz-view');
        const questionTextElement = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const submitButton = document.getElementById('submit-button');
        const nextButton = document.getElementById('next-button');
        const feedbackArea = document.getElementById('feedback-area');
        const feedbackMessage = document.getElementById('feedback-message');
        const explanationText = document.getElementById('explanation-text');
        const questionLoading = document.getElementById('question-loading');
        const explanationLoading = document.getElementById('explanation-loading');
        const askForMoreDetailsButton = document.getElementById('ask-for-more-details-button');
        const questionArea = document.getElementById('question-area');

        // DOM Elements - Score Display
        const scoreDisplay = document.getElementById('score-display');
        const correctCountSpan = document.getElementById('correct-count');
        const incorrectCountSpan = document.getElementById('incorrect-count');

        // DOM Elements - Chat View
        const chatView = document.getElementById('chat-view');
        const chatHistoryDiv = document.getElementById('chat-history');
        const userChatInput = document.getElementById('user-chat-input');
        const sendChatButton = document.getElementById('send-chat-button');
        const chatLoading = document.getElementById('chat-loading');
        const backToQuizButton = document.getElementById('back-to-quiz-button');


        /**
         * Updates the score display on the UI.
         */
        function updateScoreDisplay() {
            correctCountSpan.textContent = `Correct: ${correctCount}`;
            incorrectCountSpan.textContent = `Incorrect: ${incorrectCount}`;
        }

        /**
         * Fetches a new electrical engineering question from the Gemini AI.
         * The response is expected to be a JSON object with question, options, correctAnswer,
         * initialExplanation, and topic.
         */
        async function generateQuestionFromAI() {
            try {
                const apiKey = "AIzaSyCr3VbItQdykUs_uNbudLITohWmuFnGz54"; // Canvas will provide this at runtime if empty
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const prompt = `Generate a multiple-choice question about electrical engineering. The question should cover one of these topics: 'loads powers', 'MCB breaker types', 'MCB breaker amperes', or 'wire sizes'. Provide exactly four options, and specify the index of the correct answer (0, 1, 2, or 3). Also, provide a concise, initial explanation for the correct answer. Output should be a JSON object with the following structure. Ensure the 'question' and 'initialExplanation' fields are actual strings, not string representations of JSON.
                { "question": "string", "options": ["string", "string", "string", "string"], "correctAnswer": "integer", "initialExplanation": "string", "topic": "string" }`;

                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "question": { "type": "STRING" },
                                "options": {
                                    "type": "ARRAY",
                                    "items": { "type": "STRING" }
                                },
                                "correctAnswer": { "type": "INTEGER" },
                                "initialExplanation": { "type": "STRING" },
                                "topic": { "type": "STRING" }
                            },
                            "propertyOrdering": ["question", "options", "correctAnswer", "initialExplanation", "topic"]
                        }
                    }
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const jsonString = result.candidates[0].content.parts[0].text;
                    return JSON.parse(jsonString);
                } else {
                    console.error("Could not generate a valid question from AI:", result);
                    // Fallback to a generic question if AI generation fails
                    return {
                        question: "Failed to generate question. What is 2+2?",
                        options: ["3", "4", "5", "6"],
                        correctAnswer: 1,
                        initialExplanation: "This is a fallback question due to an error.",
                        topic: "basic math"
                    };
                }
            } catch (error) {
                console.error("Error calling Gemini API for question generation:", error);
                // Fallback to a generic question on network error
                return {
                    question: "Network error loading question. What is the capital of France?",
                    options: ["Berlin", "London", "Paris", "Rome"],
                    correctAnswer: 2,
                    initialExplanation: "This is a fallback question due to a network error.",
                    topic: "geography"
                };
            }
        }

        /**
         * Preloads the next question in the background.
         */
        async function preloadNextQuestion() {
            nextQuestionPreloaded = await generateQuestionFromAI();
            console.log("Next question preloaded:", nextQuestionPreloaded);
        }

        /**
         * Renders the current question and its options to the UI.
         */
        async function displayQuestion() {
            // Hide previous feedback and question area during transition
            quizView.classList.add('hidden');
            chatView.classList.add('hidden'); // Ensure chat view is hidden
            feedbackArea.classList.add('hidden'); // Hide feedback area for new question

            updateScoreDisplay(); // Update score display

            if (nextQuestionPreloaded) {
                currentQuestion = nextQuestionPreloaded;
                nextQuestionPreloaded = null; // Clear preloaded question as it's now current
                questionLoading.classList.add('hidden'); // Ensure loading is hidden if preloaded
            } else {
                questionLoading.classList.remove('hidden'); // Show loading if not preloaded
                currentQuestion = await generateQuestionFromAI();
                questionLoading.classList.add('hidden'); // Hide loading once generated
            }

            if (!currentQuestion) {
                questionTextElement.textContent = "Error loading question. Please try again.";
                optionsContainer.innerHTML = '';
                submitButton.classList.add('hidden');
                nextButton.classList.add('hidden');
                return;
            }

            // Reset UI for new question
            questionTextElement.textContent = currentQuestion.question;
            optionsContainer.innerHTML = '';
            feedbackMessage.textContent = '';
            explanationText.textContent = '';
            explanationLoading.classList.add('hidden');
            askForMoreDetailsButton.classList.add('hidden');
            selectedOption = null;
            submitButton.classList.remove('hidden');
            submitButton.disabled = true;
            nextButton.classList.add('hidden');
            quizActive = true;

            currentQuestion.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('option-button');
                button.setAttribute('data-index', index);

                button.addEventListener('click', () => {
                    const currentSelected = optionsContainer.querySelector('.option-button.selected');
                    if (currentSelected) {
                        currentSelected.classList.remove('selected');
                    }
                    button.classList.add('selected');
                    selectedOption = index;
                    submitButton.disabled = false;
                });
                optionsContainer.appendChild(button);
            });

            quizView.classList.remove('hidden'); // Show quiz view after content is ready

            // Start preloading the next question immediately after displaying the current one
            preloadNextQuestion();
        }

        /**
         * Handles the submission of an answer. Checks correctness and provides feedback.
         */
        async function handleSubmit() {
            if (selectedOption === null || !quizActive || !currentQuestion) {
                return;
            }

            quizActive = false;

            const isCorrect = (selectedOption === currentQuestion.correctAnswer);

            if (isCorrect) {
                correctCount++;
            } else {
                incorrectCount++;
            }
            updateScoreDisplay(); // Update score display after submission

            submitButton.classList.add('hidden');
            nextButton.classList.remove('hidden');

            optionsContainer.querySelectorAll('.option-button').forEach((button, index) => {
                button.disabled = true;
                if (index === currentQuestion.correctAnswer) {
                    button.classList.add('correct');
                } else if (index === selectedOption) {
                    button.classList.add('incorrect');
                }
            });

            feedbackArea.classList.remove('hidden');

            if (isCorrect) {
                feedbackMessage.textContent = "Correct! ðŸŽ‰";
                feedbackMessage.style.color = '#065f46';
                explanationText.textContent = currentQuestion.initialExplanation;
                askForMoreDetailsButton.classList.remove('hidden'); // Show button for correct answers
            } else {
                feedbackMessage.textContent = "Incorrect. ðŸ™";
                feedbackMessage.style.color = '#991b1b';
                explanationLoading.classList.remove('hidden');
                explanationText.textContent = '';
                askForMoreDetailsButton.classList.add('hidden'); // Hide details button for incorrect answers initially

                const userChoiceText = currentQuestion.options[selectedOption];
                const correctAnswerText = currentQuestion.options[currentQuestion.correctAnswer];
                const prompt = `The user answered '${userChoiceText}' for the question '${currentQuestion.question}'. The correct answer is '${correctAnswerText}'. Please explain concisely why '${userChoiceText}' is incorrect and why '${correctAnswerText}' is correct in the context of electrical engineering principles related to ${currentQuestion.topic}. Keep it to 2-3 sentences.`;

                try {
                    const apiKey = "AIzaSyCr3VbItQdykUs_uNbudLITohWmuFnGz54";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                    const payload = {
                        contents: [{ role: "user", parts: [{ text: prompt }] }]
                    };

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        explanationText.textContent = result.candidates[0].content.parts[0].text;
                        askForMoreDetailsButton.classList.remove('hidden'); // Show details button after AI explanation
                    } else {
                        explanationText.textContent = "Could not generate an explanation. Please try again.";
                    }
                } catch (error) {
                    console.error("Error calling Gemini API for incorrect explanation:", error);
                    explanationText.textContent = "Error generating explanation. Network issue or API error.";
                } finally {
                    explanationLoading.classList.add('hidden');
                }
            }
        }

        /**
         * Displays a chat message in the chat history.
         * @param {string} text - The message text.
         * @param {string} sender - 'user' or 'ai'.
         */
        function displayChatMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message', sender);
            messageDiv.textContent = text;
            chatHistoryDiv.appendChild(messageDiv);
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight; // Scroll to bottom
        }

        /**
         * Initializes and displays the chat view.
         */
        async function handleAskForMoreDetails() {
            if (!currentQuestion) return;

            quizView.classList.add('hidden');
            chatView.classList.remove('hidden');
            scoreDisplay.classList.add('hidden'); // Hide score in chat view
            chatHistoryDiv.innerHTML = ''; // Clear previous chat history
            chatHistory = []; // Reset chat history for new conversation

            // Initial AI message based on the quiz question context
            const initialPrompt = `Hello! I can help you with more details about electrical engineering. What would you like to know about '${currentQuestion.topic}' or '${currentQuestion.question}'?`;
            
            // Add initial AI message to history and display
            chatHistory.push({ role: "model", parts: [{ text: initialPrompt }] });
            displayChatMessage(initialPrompt, 'ai');
        }

        /**
         * Sends a user message and gets an AI response.
         */
        async function sendChatMessage() {
            const userMessage = userChatInput.value.trim();
            if (!userMessage) return;

            displayChatMessage(userMessage, 'user');
            chatHistory.push({ role: "user", parts: [{ text: userMessage }] });
            userChatInput.value = ''; // Clear input

            chatLoading.classList.remove('hidden'); // Show AI typing indicator
            sendChatButton.disabled = true; // Disable send button

            try {
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        temperature: 0.7, // Adjust temperature for more focused or creative responses
                    }
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const aiResponse = result.candidates[0].content.parts[0].text;
                    displayChatMessage(aiResponse, 'ai');
                    chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
                } else {
                    displayChatMessage("I'm having trouble understanding. Can you rephrase?", 'ai');
                }
            } catch (error) {
                console.error("Error in chat API call:", error);
                displayChatMessage("Oops! There was an error. Please try again later.", 'ai');
            } finally {
                chatLoading.classList.add('hidden'); // Hide AI typing indicator
                sendChatButton.disabled = false; // Re-enable send button
            }
        }

        /**
         * Switches back to the quiz view.
         */
        function handleBackToQuiz() {
            chatView.classList.add('hidden');
            quizView.classList.remove('hidden');
            scoreDisplay.classList.remove('hidden'); // Show score again in quiz view
        }

        /**
         * Advances to the next question.
         */
        function handleNext() {
            displayQuestion(); // This will use the preloaded question if available
        }

        // Event Listeners
        submitButton.addEventListener('click', handleSubmit);
        nextButton.addEventListener('click', handleNext);
        askForMoreDetailsButton.addEventListener('click', handleAskForMoreDetails);
        sendChatButton.addEventListener('click', sendChatMessage);
        userChatInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) { // Allow Shift+Enter for new line
                event.preventDefault(); // Prevent default Enter behavior (e.g., new line)
                sendChatMessage();
            }
        });
        backToQuizButton.addEventListener('click', handleBackToQuiz);


        // Initial display of the first question when the window loads
        window.onload = function() {
            displayQuestion(); // This will trigger the first question generation and then preload the next
        };
    </script>
</body>
</html>
